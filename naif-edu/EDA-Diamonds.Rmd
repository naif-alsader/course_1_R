---
title: "Diamonds-EDA"
author: "Naif"
date: "7/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




<!-- ggplot2`s key components: (10) -->

<!-- 1. Data -->
<!-- 1. Aesthetic mappings -->
<!-- 1. Layers (geom) -->


<!-- ggplot2`s template: (5) -->

<!-- ggplot(data = <DATA>) +  -->
<!--   <GEOM_FUNCTION>( -->
<!--      mapping = aes(<MAPPINGS>), -->
<!--      stat = <STAT>,  -->
<!--      position = <POSITION> -->
<!--   ) + -->
<!--   <COORDINATE_FUNCTION> + -->
<!--   <FACET_FUNCTION> -->


<!-- ggplot2`s cheatsheet: (5) -->

<!-- https://github.com/rstudio/cheatsheets/blob/master/data-visualization-2.1.pdf -->



---------------------------------------------------------


## Diamonds EDA

Overview:

The aim of this work is to study the affect of other variables on diamond`s price.



### Load data 

```{r}
library(tidyverse)
library(patchwork)
library(skimr)

diamonds <- read_csv("https://raw.githubusercontent.com/tidyverse/ggplot2/master/data-raw/diamonds.csv")



cut_levels = c("Fair", "Good", "Very Good", "Premium", "Ideal")
color_levels = c("D", "E", "F", "G", "H", "I", "J")
clarity_levels = c("I1", "SI2", "SI1",  "VS2",  "VS1",  "VVS2", "VVS1", "IF")


diamonds <- diamonds %>% 
  mutate(
    cut = factor(cut, levels = cut_levels, ordered = TRUE),
    color = factor(color, levels  = color_levels, ordered = TRUE),
    clarity = factor(clarity, levels  = clarity_levels, ordered = TRUE))
```



--------------------------------------------------------


### Quality report (10)

```{r}

library(skimr)

diamonds %>% 
  skim()

```



---------------------------------------------------------
  
### Numeric

* price

```{r}

diamonds %>%
  ggplot(aes(x = price)) +
  geom_histogram() +
  scale_x_log10()

```





-------------------------------------------------------


* other

```{r}
diamonds %>%
  select(where(is.numeric)) %>% 
  mutate(id = row_number()) %>% 
  pivot_longer( cols =  -id) %>% 
  ggplot(aes(x = value)) + 
  geom_histogram() + 
  facet_wrap(~name) + 
  facet_wrap(~name, scales = "free") 

```

```{r}
diamonds %>%
  select(where(is.numeric)) %>% 
  mutate(id = row_number()) %>% 
  pivot_longer( cols =  -id)%>% 
  ggplot(aes(x = value)) + 
  geom_boxplot() + 
  facet_wrap(~name) + 
  facet_wrap(~name,
             scales = "free") 
```





------------------------------------------

### Categoric


```{r}

diamonds %>%
  select(where(is.factor))  %>% 
  mutate(id = row_number()) %>% 
  pivot_longer(cols = -id, values_ptypes = list(value = 'character')) %>% 
  mutate(value = factor(value, c(cut_levels, color_levels, clarity_levels), ordered = TRUE)) %>% 
  ggplot(aes(y = value)) + 
  geom_bar() + 
  facet_wrap(~name) + 
  facet_wrap(~name, scales = "free") 


```

### Data qualiry plan

feature | issue                    | potential soluation|  comment        
--------|--------------------------|--------------------|------------------
price   | Right skewed             | take log           | result is bimodal
carat   | Right skewed             | take log           |
depth   | Outlier (right-left)     |                    | is it valid? 
table   | Outlier (right-left)     |                    | is it valid? 
x       | Outlier (right-left)     |                    | is it valid? 
y       | Outlier (right-left)     |                    | is it valid? 
z       | Outlier (right-left)     |                    | is it valid? 
clarity | very view of `I1,IF`     |                    |
color   |                          |                    |
cut     | very view of `Fair`      |                    |



-----------------------------------------------

### Relationship

* Price vs Carat scatter-plot

```{r}

price_carat<-diamonds %>% 
  ggplot(aes(x =  carat,
             y = price )) +
  geom_point() +
  ggtitle("before log10")


price_carat_log<-diamonds %>% 
  ggplot(aes(x =  carat,
             y = price )) +
  geom_point() + 
  scale_y_log10()  + 
  scale_x_log10()  +
  ggtitle("after log10")


price_carat + price_carat_log

```
there is a strong relationship between Carat and price correlation is`r cor(diamonds$carat,diamonds$price)` and after we take the log of both correlation is `r cor(log10(diamonds$carat),log10(diamonds$price))`. 


* Price vs cut

```{r}
# install.packages("patchwork")
# install.packages("ggridges")
library(ggridges)
library(patchwork)


price_cut_box<-diamonds %>% 
  ggplot(aes(x =  cut,
             y = price)) +
  geom_boxplot() +
  scale_y_log10()


price_cut_dens<- diamonds %>% 
  ggplot(aes(y =  cut,
             x = price)) + 
  geom_density_ridges() +
  scale_x_log10() 

price_cut_box + coord_flip() + price_cut_dens

```


why as the cut quality increases median price decreases? 

[ask google](https://beyond4cs.com/cut/effects-on-pricing/)





* price vs cut vs carat.


```{r}
p1<-diamonds %>% 
  ggplot(aes(y = price, x = carat)) +
  geom_jitter() +
  scale_x_log10() +
  scale_y_log10() 

p2<-diamonds %>% 
  ggplot(aes(y = price, x = cut)) +
  geom_boxplot() +
  scale_y_log10() 
 
p3<-diamonds %>% 
  ggplot(aes(y = carat, x = cut)) +
  geom_boxplot() +
  scale_y_log10() 



p4<- diamonds %>% 
  ggplot(aes(x = log10(carat), y = log10(price), color = cut)) +
  geom_jitter(alpha = .2) +
  geom_smooth() 


(p1 + p2 + p3)/p4


```




<!-- ```{r} -->

<!-- lm(data = diamonds, log(price) ~ as.character(cut) + log(carat)) %>% summary() -->


<!-- ``` -->

```{r}
diamonds %>% #BREAK
  mutate(carat = cut_width(carat, 1)) %>% #BREAK
  ggplot(aes(x = price,
             fill = carat)) + #BREAK
  geom_histogram() +#BREAK
  scale_x_log10() 
```



### مصفوفة الارتباط

```{r diamonds_heatmaply_cor}

library(heatmaply)


diamonds_cor <- diamonds %>%
  select(where(is.numeric)) %>% #BREAK
  cor() #BREAK


diamonds_cor %>% #BREAK
heatmaply_cor() #BREAK

```




-------------------------------

## Day 2



### Data transformation


#### Most functions are:

* `Filter()`: اختر المشاهدات بناء علي قيمة معينة في احد الاعمدة
* `select()`: اختر المتغيرات
* `arrange()`: رتب المشاهدات بناء على قيمة معينة
* `mutate()`: انشاء متغير جديد 
* `summarise()`: استخراج نتيجة معينة من البيانات


#### load data

```{r}
#install.packages("nycflights13")
library(nycflights13)

flights


```

```{r}

flights %>% 
  skimr::skim()
```


## How to answer these questions:


### filter

* الرحلات المتأخرة لسعاتين او اكثر


```{r}
knitr::include_graphics("https://d33wubrfki0l68.cloudfront.net/01f4b6d39d2be8269740a3ad7946faa79f7243cf/8369a/diagrams/transform-logical.png")
```



الرحلات المغادرة في جولاي وسبتمبر واغسطس

```{r}
flights %>% 
  filter(month %in% c(7,8,9))

flights %>% 
  filter(month %in% 7:9)


flights %>% 
  filter(month >= 7 & month <= 9)

flights %>% 
  filter(month == 7 |  month == 8 | month ==  9)

flights %>% 
  filter( between(month, 7, 9))
```

* الرحلات التي لم تغادر في جولاي و اغسطس وجولاي

```{r}
flights %>% 
  filter(!month %in% c(7,8,9))

flights %>% 
  filter(month != 7 &  month != 8 & month !=  9)

```



* الرحلات لجميع المشغلين باستثناء 
`DL` 
دلتا

```{r}
flights %>% 
  filter(carrier != "DL")

```




```{r}
flights %>% 
  filter(is.na(dep_delay)) %>% 
  count()


```




---------------------


### Arrange

رتب الرحلات حسب الاسرع
`air_time`


```{r}

flights %>% 
  arrange(desc(air_time))

```


* اوجد اسرع ١٠ رحلات
`air_time`

```{r}

flights %>% 
  slice_max(air_time, n = 10)

```



### Select


* استبعد اعمدة السنة والشهر واليوم

```{r}

flights %>% 
  select(-c(day,month, year))


flights %>% 
  select(-c(1:3))

```


* اختر جميع الاعمدة التي تبداء ب
`dep_` 
او
`arr_`

```{r}

flights %>% 
  select(starts_with("dep_"), starts_with("arr_"))

```


* اختر جميع الاعمدة التي تحتوي على
`dep_` 
او
`arr_`

```{r}
flights %>% 
  select(contains("dep_"), contains("arr_"))

```


### Mutate

* احسب 
`arr_time - dep_time`
وسمة 
`ait_time2`

```{r}
flights %>% 
  mutate(air_time2 = arr_time - dep_time)
```



-------------------------
* عدد الرحلات حسب كل محطة الوصول
`dest`

```{r}
flights %>% 
  group_by(dest) %>% 
  count(sort = TRUE)


flights %>% 
  group_by(dest) %>% 
  summarise(n = n(),
            distnce_avg =  mean(distance))



```


* احسب متوسط 
`dep_delay`
لكل يوم وشهر وسنة

```{r}

```

--------------


### Tidying




```{r}

gapminder <- read_csv("https://raw.githubusercontent.com/OHI-Science/data-science-training/master/data/gapminder_wide.csv")

```

* هل هذة البيانات بشكلها الحالي جاهزة للعمل عليها؟

* كم متغير عندنا؟

* 

--------

tidy data


```{r, echo=FALSE}
knitr::include_graphics("https://d33wubrfki0l68.cloudfront.net/6f1ddb544fc5c69a2478e444ab8112fb0eea23f8/91adc/images/tidy-1.png")
```





```{r}

gapminder %>% 
  #rename_with(~str_remove(.,"gdpPercap_")) %>% 
  pivot_longer(3:38, names_to  = "year", values_to  = "gdpPercap") %>% 
  separate(year, c("extra", "year"), sep = "_") 

```


```{r}
gapminder_long <-gapminder %>% 
  #rename_with(~str_remove(.,"gdpPercap_")) %>% 
  pivot_longer(3:38, names_to  = "year", values_to  = "gdpPercap") %>% 
  separate(year, c("measure", "year"), sep = "_") 
```


عكس العملية

```{r}

gapminder_long %>% 
  unite(col = year, measure, year) %>% 
  pivot_wider( names_from  = "year", values_from  = "gdpPercap")  
  
```


---

```{r}

gapminder_rows<-gapminder_long %>% 
  distinct(continent, country) %>% 
  nest(country) %>% 
  mutate(data = map_chr(data,~paste( ..1$country,collapse =  ", ")) )  
  

gapminder_rows %>% 
  separate_rows(data, sep = ", ")

```

---

joining




---
# المراجع
* https://r4ds.had.co.nz/explore-intro.html
* https://clauswilke.com/dataviz/introduction.html
* https://openintro-ims.netlify.app
* http://www.feat.engineering
* https://adv-r.hadley.nz/vectors-chap.html




```{r}


flights %>% 
  skimr::skim()




```

